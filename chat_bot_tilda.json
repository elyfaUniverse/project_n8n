{
  "name": "chat_bot_tilda",
  "nodes": [
    {
      "parameters": {
        "public": true,
        "mode": "webhook",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        -624,
        -64
      ],
      "id": "5cb55312-4789-478c-a524-2f4aa8c97369",
      "name": "When chat message received",
      "webhookId": "a454dc8e-8fc7-4cc6-bc28-da352f100428"
    },
    {
      "parameters": {
        "model": "openai/gpt-3.5-turbo",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -128,
        96
      ],
      "id": "45f57ec6-8981-40ac-b63a-5d81650f5a1a",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "rUgfnyrchWzLfPdr",
          "name": "OpenRouter account 3"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const llmResponse = $input.first().json;\n\nconsole.log('ü§ñ –û—Ç–≤–µ—Ç –æ—Ç LLM:', llmResponse);\n\nlet aiResponse = '';\n\nif (llmResponse.response) {\n  aiResponse = llmResponse.response;\n} else if (llmResponse.choices && llmResponse.choices[0] && llmResponse.choices[0].message) {\n  aiResponse = llmResponse.choices[0].message.content;\n} else if (llmResponse.content) {\n  aiResponse = llmResponse.content;\n} else if (llmResponse.text) {\n  aiResponse = llmResponse.text;\n} else {\n  aiResponse = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ —Å–∞–π—Ç–∞ Universelyfa.';\n}\n\nconsole.log('üí¨ –û—Ç–≤–µ—Ç AI (—Å—ã—Ä–æ–π):', aiResponse);\n\n// ‚ö†Ô∏è –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ô HTML-–†–ê–ó–ú–ï–¢–ö–ò\nfunction fixHtmlFormatting(text) {\n  let fixedText = text;\n  \n  // 1. –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ —Ç–µ–≥–∏ </ul> –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–µ–≥–∏\n  fixedText = fixedText.replace(/<\\/ul><br>/g, '</li><br>');\n  fixedText = fixedText.replace(/<\\/ul><\\/li>/g, '</li>');\n  \n  // 2. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫\n  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞\n  const listItems = fixedText.match(/<li>[\\s\\S]*?<\\/li>/g) || [];\n  \n  if (listItems && listItems.length > 0) {\n    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HTML\n    const properHtml = \n      fixedText.split('<li>')[0] + // –¢–µ–∫—Å—Ç –¥–æ —Å–ø–∏—Å–∫–∞\n      '<ul>' + \n      listItems.map(item => item.replace(/<br>/g, '')).join('') + // –£–±–∏—Ä–∞–µ–º <br> –≤–Ω—É—Ç—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞\n      '</ul>' + \n      fixedText.split('</li>').pop(); // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞\n    \n    return properHtml;\n  }\n  \n  return fixedText;\n}\n\n// ‚ö†Ô∏è –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å—Ç—ã–π, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π HTML\nfunction formatAsProperHtml(text) {\n  // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏\n  const parts = text.split('<li>');\n  const intro = parts[0]; // –¢–µ–∫—Å—Ç –¥–æ —Å–ø–∏—Å–∫–∞\n  \n  if (parts.length < 2) {\n    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–∏—Å–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å\n    return text.replace(/<br>/g, '<br>');\n  }\n  \n  // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞\n  const listItems = [];\n  for (let i = 1; i < parts.length; i++) {\n    const item = parts[i];\n    const cleanItem = item\n      .replace(/<\\/li>[\\s\\S]*$/, '') // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ—Å–ª–µ </li>\n      .replace(/<\\/?ul>/g, '') // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–µ–≥–∏ ul\n      .replace(/<br>/g, ' ') // –ó–∞–º–µ–Ω—è–µ–º <br> –Ω–∞ –ø—Ä–æ–±–µ–ª—ã\n      .trim();\n    \n    if (cleanItem) {\n      listItems.push(cleanItem);\n    }\n  }\n  \n  // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞\n  const afterList = text.includes('</li>') \n    ? text.split('</li>').pop().replace(/<\\/?ul>/g, '').trim()\n    : '';\n  \n  // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π HTML\n  let result = intro.trim();\n  \n  if (listItems.length > 0) {\n    result += '<ul style=\"margin: 15px 0; padding-left: 25px;\">';\n    listItems.forEach(item => {\n      result += `<li style=\"margin: 8px 0; line-height: 1.5;\">${item}</li>`;\n    });\n    result += '</ul>';\n  }\n  \n  if (afterList) {\n    result += `<p style=\"margin-top: 15px;\">${afterList}</p>`;\n  }\n  \n  return result;\n}\n\n// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\nconst formattedResponse = formatAsProperHtml(aiResponse);\n\nconsole.log('üí¨ –û—Ç–≤–µ—Ç AI (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π):', formattedResponse);\n\n// ‚ö†Ô∏è –í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –û–î–ò–ù –æ–±—ä–µ–∫—Ç —Å response!\nreturn [{\n  response: {\n    statusCode: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'https://universelyfa.ru',\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n      success: true,\n      aiResponse: formattedResponse,\n      reply: aiResponse, // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏\n      timestamp: new Date().toISOString(),\n      formatted: true\n    })\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        -64
      ],
      "id": "2f3a9f63-fa10-4e22-b0fd-fb40363493fe",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –û—Ç–≤–µ—á–∞–π —á–µ—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –∏ –ø–æ –¥–µ–ª—É.  –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML-—Ç–µ–≥–æ–≤ - –†–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π - –ò—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ - –í—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã, –Ω–æ –±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ - –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -128,
        -64
      ],
      "id": "e8a0fbf8-86e1-4149-ae5c-40b0e72b39d1",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "jsCode": "// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è Basic LLM Chain\nconst input = $input.first();\nconst data = input.json || {};\n\nconsole.log('üîç –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);\n\n// –í–ê–ñ–ù–û: Basic LLM Chain —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ chatInput!\nconst output = {\n  chatInput: data.message || data.body?.message || '–ü—Ä–∏–≤–µ—Ç!',\n  \n  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏\n  metadata: {\n    sessionId: data.sessionId || data.body?.sessionId,\n    userId: data.userId || data.body?.userId,\n    source: 'tilda'\n  }\n};\n\nconsole.log('üì§ –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Basic LLM:', output);\n\nreturn [{\n  json: output\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        -64
      ],
      "id": "52228b3d-70f0-4c5b-b58d-50f00c077769",
      "name": "Code in JavaScript2"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f6d81844-ce67-4eb3-b207-41fa520f5382",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "332629f9bcfacaa1a25b9a359a5af551d01302abea4f08172266a77f2874794b"
  },
  "id": "aaLOCgMRv7pCbNBy",
  "tags": []
}