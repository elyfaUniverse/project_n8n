# Процесс автоматической выгрузки новостей из RSS-ленты в Airtable для сайта на Tilda https://universelyfa.ru/

## Общее описание
Данная система представляет собой автоматизированный workflow (в n8n), который:
1. Получает RSS-ленту новостей с сайта 3DNews
2. Парсит данные из XML-формата  
3. Обрабатывает и фильтрует новости
4. Сохраняет отфильтрованные новости в базу данных Airtable
5. **Новости становятся доступны на сайте, созданном на платформе Tilda**

## Архитектура системы

### 1. **Расписание запуска (Schedule Trigger)**
- Первый узел в workflow
- Настроен на периодическое выполнение (например, каждый час)
- Запускает весь процесс автоматически

### 2. **Получение RSS-ленты (HTTP Request)**
- Выполняет HTTP-запрос к URL: `https://3dnews.ru/breaking/rss/`
- Получает XML-данные в формате RSS
- Передает результат в следующий узел

### 3. **Конвертация в файл (Convert to File)**
- Конвертирует полученные данные в JSON-формат
- Режим работы: "each" (обрабатывает каждый элемент отдельно)
- Подготавливает данные для дальнейшей обработки

### 4. **JavaScript код для парсинга (Code Node)**

#### **Основные функции:**

##### **getTagContent()** 
Извлекает содержимое XML-тегов:
- Очищает от CDATA-блоков
- Декодирует HTML-entities (&lt;, &gt;, &amp; и др.)
- Возвращает чистый текст

##### **getImageUrl()** - **Ключевая функция поиска изображений**
Ищет URL изображений 4 способами:
1. **Прямой поиск тега enclosure** - `<enclosure url="image.jpg" />`
2. **Гибкий поиск enclosure** - с расширениями .jpg, .png, .gif
3. **Поиск любых URL изображений** - регулярное выражение для URL
4. **Поиск медиа-контента** - теги `<media:content>`

##### **getCategoryDomain()**
Извлекает категорию новости из атрибута `domain` тега `<category>`

#### **Логика обработки новостей:**

1. **Извлечение всех элементов `<item>`** из RSS
2. **Для каждой новости:**
   - Парсинг заголовка, ссылки, описания, даты, категории
   - Поиск изображения с помощью `getImageUrl()`
   - Логирование процесса

3. **Фильтрация:**
   - Проверка обязательных полей (заголовок, ссылка)
   - Удаление дубликатов внутри одного RSS-потока
   - *Проверка даты (временно отключена для тестирования)*

4. **Очистка данных:**
   - Удаление HTML-тегов из описания
   - Сокращение описания до 1000 символов
   - Упрощение категорий (Software, Hardware, Games и т.д.)

5. **Подготовка для Airtable:**
   - Форматирование данных в плоскую структуру
   - Важно: `imageUrl` передается как простая строка, не массив

### 5. **Сохранение в Airtable (Airtable Node)**
- Создание записей в таблице Airtable с именем **"Tilda_n8n"**
- База данных: `appNfPgU4FlJBD1Um`
- Таблица: `tblCWBTRnKbCCK0t1` ("Table 1")
- Соответствие полей:
  - `Title` → заголовок новости
  - `Link` → ссылка на статью
  - `Description` → очищенное описание
  - `Date` → дата публикации
  - `Select` → категория
  - `ImageUrl` → URL изображения (как строка)
- Используется Personal Access Token для аутентификации

## **Интеграция с сайтом на Tilda**

### Связь Airtable ↔ Tilda
1. **Airtable как база данных:**
   - Все обработанные новости сохраняются в Airtable
   - Airtable выступает в роли headless CMS (системы управления контентом без интерфейса)

2. **Tilda как фронтенд:**
   - На платформе Tilda создается сайт с новостным разделом
   - Сайт использует **Zero Block** для динамического контента
   - Через Zero Block настраивается подключение к Airtable API

3. **Механизм отображения:**
   - Tilda делает запросы к Airtable API
   - Получает новости в JSON-формате
   - Отображает их на сайте с помощью шаблонов Zero Block
   - Автоматически обновляется при добавлении новых записей в Airtable

### Поток данных для сайта:
```
RSS (3DNews) → n8n → Airtable ←→ Tilda API ←→ Сайт на Tilda
                (парсинг)   (хранение)      (отображение)
```

## Особенности реализации

### Для Airtable:
- Используется поле `ImageUrl` как строка (не массив) для совместимости с Tilda
- Категории упрощаются для удобной фильтрации на сайте
- Дата сохраняется в формате, понятном для Tilda

### Для Tilda:
- Zero Block настраивается на получение данных из Airtable
- Можно создать фильтры по категориям
- Изображения загружаются по URL (не требуют локального хранения)
- Дизайн полностью настраивается в визуальном редакторе Tilda

## Преимущества архитектуры

1. **Полная автоматизация:**
   - Новости автоматически парсятся и добавляются
   - Сайт автоматически обновляется

2. **Разделение ответственности:**
   - **n8n** - сбор и обработка данных
   - **Airtable** - хранение и управление данными
   - **Tilda** - отображение и дизайн

3. **Гибкость:**
   - Можно легко изменить дизайн сайта в Tilda без изменения логики парсинга
   - Можно добавить новые источники RSS в n8n
   - Можно изменить структуру данных в Airtable

4. **Экономичность:**
   - Не требуется серверное программирование для сайта
   - Используются готовые SaaS-сервисы
   - Минимальные затраты на поддержку

## Полный поток данных:
```
Расписание → HTTP запрос → XML → JSON → Парсинг JavaScript → 
→ Очистка данных → Форматирование → Airtable API → 
→ Хранение в Airtable ←→ Tilda Zero Block API → 
→ Отображение на сайте Tilda для пользователей
```
