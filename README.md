# Процесс автоматической выгрузки новостей из RSS-ленты в Airtable

## Общее описание
Данная система представляет собой автоматизированный workflow (в n8n), который:
1. Получает RSS-ленту новостей с сайта 3DNews
2. Парсит данные из XML-формата
3. Обрабатывает и фильтрует новости
4. Сохраняет отфильтрованные новости в базу данных Airtable

## Архитектура системы

### 1. **Расписание запуска (Schedule Trigger)**
- Первый узел в workflow
- Настроен на периодическое выполнение (например, каждый час)
- Запускает весь процесс автоматически

### 2. **Получение RSS-ленты (HTTP Request)**
- Выполняет HTTP-запрос к URL: `https://3dnews.ru/breaking/rss/`
- Получает XML-данные в формате RSS
- Передает результат в следующий узел

### 3. **Конвертация в файл (Convert to File)**
- Конвертирует полученные данные в JSON-формат
- Режим работы: "each" (обрабатывает каждый элемент отдельно)
- Подготавливает данные для дальнейшей обработки

### 4. **JavaScript код для парсинга (Code Node)**

#### **Основные функции:**

##### **getTagContent()** 
Извлекает содержимое XML-тегов:
- Очищает от CDATA-блоков
- Декодирует HTML-entities (&lt;, &gt;, &amp; и др.)
- Возвращает чистый текст

##### **getImageUrl()** - **Ключевая функция поиска изображений**
Ищет URL изображений 4 способами:
1. **Прямой поиск тега enclosure** - `<enclosure url="image.jpg" />`
2. **Гибкий поиск enclosure** - с расширениями .jpg, .png, .gif
3. **Поиск любых URL изображений** - регулярное выражение для URL
4. **Поиск медиа-контента** - теги `<media:content>`

##### **getCategoryDomain()**
Извлекает категорию новости из атрибута `domain` тега `<category>`

#### **Логика обработки новостей:**

1. **Извлечение всех элементов `<item>`** из RSS
2. **Для каждой новости:**
   - Парсинг заголовка, ссылки, описания, даты, категории
   - Поиск изображения с помощью `getImageUrl()`
   - Логирование процесса

3. **Фильтрация:**
   - Проверка обязательных полей (заголовок, ссылка)
   - Удаление дубликатов внутри одного RSS-потока
   - *Проверка даты (временно отключена для тестирования)*

4. **Очистка данных:**
   - Удаление HTML-тегов из описания
   - Сокращение описания до 1000 символов
   - Упрощение категорий (Software, Hardware, Games и т.д.)

5. **Подготовка для Airtable:**
   - Форматирование данных в плоскую структуру
   - Важно: `imageUrl` передается как простая строка, не массив

### 5. **Сохранение в Airtable (Airtable Node)**
- Создание записей в таблице Airtable
- Соответствие полей:
  - `Title` → заголовок новости
  - `Link` → ссылка на статью
  - `Description` → очищенное описание
  - `Date` → дата публикации
  - `Select` → категория
  - `ImageUrl` → URL изображения (как строка)
- Используется Personal Access Token для аутентификации

## Особенности реализации

### Обработка ошибок
- Проверка наличия данных на каждом этапе
- Подробное логирование всех действий
- Статистика обработки (сколько добавлено, сколько пропущено)
- Graceful degradation при ошибках

### Логирование
- Детальные console.log на каждом этапе
- Статистика по всем обработанным новостям
- Отображение первых 5 записей для проверки

### Гибкость
- Модульная структура кода
- Легко добавить новые источники RSS
- Возможность настройки фильтров (по дате, категориям)

## Поток данных
```
Расписание → HTTP запрос → XML → JSON → Парсинг JavaScript → 
→ Очистка данных → Форматирование → Airtable API → База данных
```

## Технические детали
- **Язык**: JavaScript (Node.js среда выполнения)
- **Формат данных**: XML (RSS) → JSON → Airtable формат
- **Аутентификация**: Airtable Personal Access Token
- **Обработка ошибок**: Try-catch с возвратом понятных сообщений

## Преимущества подхода
1. **Автоматизация** - не требует ручного вмешательства
2. **Надежность** - проверка данных на каждом этапе
3. **Масштабируемость** - легко добавить новые RSS-источники
4. **Гибкость** - можно настроить фильтры под конкретные нужды
5. **Интеграция** - готовое решение для Airtable

Система обеспечивает регулярное обновление новостной базы с минимальными затратами на поддержку и высокой степенью автоматизации.
